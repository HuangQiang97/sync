## 波束管理
内容：波束搜索、波束扫描、波束上报、波束切换、波束恢复、波束追踪、波束选择。

#### 概述

https://ww2.mathworks.cn/campaigns/offers/next/understanding-5g-beam-management.html

1，波束管理：用于获取和保持波束，是一组第 1 层 (PHY) 和第 2 层 (MAC) 程序，用于建立和保持最佳波束对以实现良好的连接性。定向链路需要在 gNodeB (gNB) 和 UE 处精确对齐波束，其中 UE 和 gNB 定期识别在任何给定时间点工作的最佳波束。

2，3GPP 为 5G NR 定义了一套波束管理程序，适用于两种操作模式：

- 空闲模式：这是当 UE 没有活动数据传输时。当 UE 在唤醒后打开或重新启动连接，第一次尝试连接到网络时，将使用空闲模式过程。空闲模式下的波束管理将有助于建立定向初始访问。此时下行链路使用 PSS/SSS/PBCH DMRS(即 SSB)进行管理，上行链路未规定。

- 连接模式：这是当 UE 和 gNB 之间发生活动数据交换并且 UE 在小区内移动时。在这种模式下，由于毫米波的特性，信号很可能会迅速恶化，因此实时管理波束将有助于保持健康的链路。使用 CSI-RS、SSBlock(在下行)和SRS (在上行)进行管理。

    <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/2021-12-16_20-26-44.jpg" alt="2021-12-16_20-26-44" style="zoom: 50%;" />

3，波束管理流程（独立组网/非独立组网）

3.1 下行

![独立组网方案](%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/1616701758313.png)

<center>独立组网</center>

<img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/2021-12-16_21-24-54.jpg" alt="2021-12-16_21-24-54" style="zoom:70%;" />



<center>非独立组网</center>

* Beam Sweeping：gNB 以固定的间隔在SS Burst中向所有方向发送波束，SS Burst周期{5; 10; 20; 40; 80; 160}ms。每当 UE 与网络同步时，它都会检测搜索空间中的所有波束并且读取同步信号块 (SSB) ，1 个SS Block在时间轴上占用4个OFDM符号，在频域轴上占用240个子载波（20 个资源块），UE提取SS Block中的内容：主同步信号（PSS）、辅助同步信号（SSS）、物理广播信道（PBCH）和解调参考信号（DMRS，被UE用来计算SS块的信号强度），获得初始小区同步和系统信息。每个SS Block对应于一个特定方向的波束，在不同方向上形成波束。一组 SS Block形成一个跨越 5ms 窗口的 SS Burst，SS Burst中SSS Block的最大数量取决于工作频率范围，SS Burst以 20 ms 的周期周期性地重复。

    ![350787](%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/350787.png)

    <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/1616701758404.jpg" style="zoom: 67%;" />

* Beam Measurement and Determination：UE通过测量接收信号功率来测量波束强度，一个SS Burst set中全部的SSB, 并找到信号最好的SSB。在空闲模式下，它基于同步信号，在连接模式下，它基于下行链路中的通道状态信息参考信号(CSI-RS，用于移动性的管理，CSI-RS占用N = 1/2/4 个OFDM符号) 和上行链路中的声音参考信号(SRS，监控上行信道的质量) 。UE 使用 gNB 定义的预定义阈值标准定期搜索最佳波束，并识别所有发射-接收波束对中具有最高参考信号接收功率 (RSRP) 的波束，以确定具有最大 RSRP 的波束对链路。

* Beam Reporting：UE识别的最佳波束通知gNB。UE 发送与识别出最佳波束的 SSB相对应的物理 RACH (PRACH) 前导码。接收到的 SSB和发送的 RACH 前导码之间存在一对一的映射关系。这是 UE 向 gNB 报告最佳波束的一种方式。

    * 独立组网：在初始化连接时移动终端必须等待 gNB 将 RACH 机会调度到 UE 刚刚确定的最佳方向，以执行随机接入并隐式通知所选服务基础设施最佳方向（或一组方向），它必须通过它来操纵光束，以便正确对齐；在连接模式下，当 UE 已经与 gNB 连接并且正在进行活动数据传输时，它会通过测量报告向 gNB 报告波束。
    * 非独立组网：可以改进波束报告阶段。由于控制平面与覆盖层集成，LTE 连接可用于向 gNB 报告最佳方向集，因此 UE 无需等待来自 gNB 的额外波束扫描来执行波束报告或 IA 程序。

* Beam Recovery：在由于信道条件差导致波束失效的情况下，会触发波束恢复过程以恢复新的波束。一旦满足失败触发条件，UE监控参考信号并识别波束失败。当波束故障发生时，UE 选择下一个最佳波束在随机接入 (RA) 前导码中发送。如果 RA 的第一次尝试失败，它将扫描到另一个波束以进行另一个 RA 程序。RA 前导在 PRACH 中发送。最后，UE 在物理下行链路控制信道 (PDCCH) 上接收下行链路资源分配和上行链路授权。

* Beam Switching：从一个波束切换到另一个波束也可以称为*小区内移动性*或*波束级移动性*。波束切换基于波束的触发条件和配置的波束切换算法。

3.2，上行

<center>
  <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/2021-12-18_13-12-36.jpg" alt="2021-12-18_13-12-36" style="zoom:67%;" />  
    <p>
        独立组网
    </p>
</center>



<center>
      <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/giord5-2869411-small.gif" alt="2021-12-18_13-12-36" style="zoom:67%;" /> 
    <p>
        非独立组网上行
    </p>
</center>

在低于 6 GHz 频率下运行的 LTE 演进节点基站 (eNB)，可以实现高效的测量操作。来自 UE 的上行链路传输将在任何附近的毫米波小区大致时间对齐。

* 光束扫描和光束测量：每个 UE 在 mmWave 频段中以时变方向定向广播 SRS，连续扫描角空间。每个潜在的服务 gNB 也会扫描其所有角度方向，监控接收到的 SRS 的强度并根据每个接收方向的信道质量构建*报告表*，以捕获信道的动态。

* 光束测定：一旦为每个 UE 填写了每个毫米波 gNB 的报告表，每个毫米波小区都会将此信息发送到 LTE eNB它控制的细胞的知识。因此，它能够匹配发射器和接收器的波束以提供最大性能。

* 波束报告：协调器在传统 LTE 连接上向 UE 报告哪个 gNB 产生最佳性能，以及 UE 应该控制其波束的最佳方向，以便以最佳方式到达候选服务小区。在跟踪期间选择使用 LTE 控制链路的动机是，如果未正确对齐，UE 可能无法从最佳毫米波链路接收，从而消除控制信令路径中可能的故障点。此外，由于链路故障导致毫米波机制中的路径切换和小区添加很常见，因此到服务毫米波小区的控制链路也可能不可用。最后，协调器通过回程高容量链路通知指定的 gNB，关于引导波束以服务每个 UE 的最佳方向。

4，3GPP TR 38.802 波束管理定义：

* P1基于 SSB 的光束扫描：该过程侧重于基于 SSB 对空闲模式 UE 的初始获取。在初始采集期间，发射端和接收端都会进行波束扫描，以根据 RSRP 测量值选择最佳波束对。通常所选波束很宽，可能不是用于数据传输和接收的最佳波束对。连接后，波束将使用 CSI-RS（用于下行链路）和 SRS（用于上行链路）进一步细化。

    <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/image-20211214153134457.png" style="zoom:50%;" />

    为了实现发送端波束扫描，对生成的SSB集使用模拟波束成形进行波束成形。根据突发中的 SSB数和指定的扫描范围，确定不同波束的方位角和仰角。然后将突发中的各个块波束形成到这些方向中的每一个。然后通过空间感知散射通道传输波束形成的突发波形。对于接收端波束扫描，在每个接收波束上连续接收传输的波束成形突发波形。对于N 个发射波束和 M 个接收波束，N 个波束中的每一个从 gNB 发射 M 次，以便每个发射波束通过 M 个接收波束接收。

    ![](%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/1616701759101.webp)

* P2基于 CSI-RS 的发射端波束细化：初始波束建立后，要获得高方向性和高增益的单播数据传输，需要比单边带波束更精细的波束，使用数字波束成形可以使用更窄的波束来限制来自多个用户的干扰。因此从初始采集过程开始，在波束的角度范围内，使用更精细的波束在不同方向上配置和传输一组参考信号资源。然后 UE 通过使用固定接收波束捕获信号来测量所有这些波束。最后根据对所有发射波束的 RSRP 测量选择最佳发射波束。此过程侧重于发送端波束细化，其中通过保持接收波束固定在发送端进行波束扫描。

    <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/1616701759322.webp" alt="1616701759322" style="zoom:60%;" />

    <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/1616701759255.webp" style="zoom:67%;" />

* P3基于 CSI-RS 的接收端波束细化：此过程专注于接收端波束调整，在给定当前发射波束的情况下，波束扫描发生在接收端。该过程旨在找到最佳接收波束，可以是相邻波束或细化波束。对于这个过程，一组参考信号资源（下行的CSI-RS 和上行的 SRS）使用相同的发射波束发送，UE 或 gNB 使用来自不同的不同波束接收信号。最后根据对所有接收波束的 RSRP 测量选择最佳接收波束。

#### 帧结构

[5G NR帧结构 ](https://zhuanlan.zhihu.com/p/64108857)

[5G NR频域资源 ](https://zhuanlan.zhihu.com/p/64784177)

[帧结构](https://sharetechnote.com/)

NR资源分：时域、频域、空域。

1，时域：

* 采样点： 4096，5G NR的采样点时间间隔：$T_s=\frac{1}{2^{\mu} * 15000 * 4096} $，其中$2^{\mu} * 15000 $是子载波间隔(15kHz~240kHz)，4096是采样点个数。LTE子载波间隔15kHz，采样点个数2048。5G NR最小时间单元相比LTE小32倍。

* 符号symbol：5G NR引入minislot符号数可变。符号由CP+Data组成，即$T_{symbol}=T_{data}+T_{cp}=\frac{71.35}{2^\mu}us$，$T_{data}=\frac{1}{SCS},T_{cp}=\frac{144*T_{data}}{2048}=\frac{144}{2048*SCS}$，SCS：SubCarrier Spacing，子载波间隔，符号是调制的基本单位，符号持续时间与子载波间隔成反比。

* 时隙slot：一个时隙包含14个OFDM符号符号，$T_{slot}=\frac{1}{2^\mu}ms$，一个时隙与一个载波间隔面积为15。每个时隙的14个符号可以按照规定的格式部分用于上行、部分用于下行，来满足不同的上下行负荷场景。

* 子帧subframe：时长为1ms，每个子帧由若干个时隙组成，时隙个数$2^\mu$，符号个数$10*2^\mu$。

* 无线帧frame：时长为10ms，一个无线帧包含10个子帧，$10\times2^\mu$个时隙。

<img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/v2-3fd75194a3f3e6de4a77424accdb041e_720w.jpg" alt="v2-3fd75194a3f3e6de4a77424accdb041e_720w" style="zoom:67%;" />

<img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/NR_Numerology_FrameStructure_u_3__NormalCP_38_211_01.png" style="zoom:67%;" />

2，频域：

* 子载波间隔：NR的子载波间隔在LTE的15kHz的基础上以2的幂次方扩展：$\Delta f=2^{\mu} \cdot 15[\mathrm{kHz}]$，以适应不同业务需求和信道特征，Rel15中规定最多有 3300 个子载波，最大带宽为 400 MHz。多普勒效应决定了子载波间隔的最小值，如果子载波间隔太小，相位噪声会产生过高的信号误差；循环前缀CP决定了子载波间隔的最大值，如果子载波间隔太大，OFDM符号中的CP持续时间就短，CP的持续时间必须大于信道的时延扩展，否则就起不到克服多径干扰的作用。子载波间隔越小，符号长度和CP越长，覆盖越好；子载波间隔越大，符号长度和CP越短，多普勒频移影响越小，时延越小，相噪影响越小，性能越好。5G(NR)支持FR1和FR2频段，FR1频率范围：450-6000MHZ；FR2是毫米波，频率范围:24.25- 52.6GHzC-band，C波段（頻率在4-8 GHz）建议子载波间隔30kHz，28GHz建议120kHz。

* RE：Resource Element，物理层最小粒度的资源。频域1个子载波，时域1个OFDM符号。

* RB：Resource Block，数据信道资源分配的频域基本调度单位。频域上是12个子载波，占据带宽$2^\mu*1.8*10^5Hz$，资源块是一个频域概念，没有定义时域。

* RG：Resource Grid，物理层资源组，频域上为传输带宽内可用的RB资源个数 ![[公式]](https://www.zhihu.com/equation?tex=N_%7BRB%7D) ，时域上为1个子帧。

    <center>
        <img src="%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/NR_Resource_Grid_01.png" alt="NR_Resource_Grid_01" style="zoom:67%;" />
    </center>
    ​        

#### A Tutorial on Beam Management for 3GPP NR at mmWave Frequencies

* 波束管理：实现发射器和接收器波束的精确对准。它们是执行各种控制任务的基础，包括 (i) 初始访问 (IA) ，对于空闲用户，它允许移动 UE 与 gNB 建立物理链路连接，以及 (ii) 波束跟踪；对于连接的用户，它启用波束自适应方案，并可以触发切换、路径选择和无线电链路故障恢复过程。

* 在毫米波频段中，即使在初始访问期间以及通常用于控制操作期间，也可能必须利用天线增益。如此高频率的全向控制信令实际上可能会在可以检测到小区或可以接收控制信号的相对较短的范围（控制平面范围）与用户可以接收的更长的范围之间产生失配。

* 当为传输配置窄波束、小子载波间隔、更密集的网络部署和采用*频率分集*方案时，可以保证准确的波束管理操作。

* 实现移动用户高效快速的初始接入和反应跟踪的最佳设计选择严格取决于用户部署的特定环境，并且必须考虑几个特定的特征，例如基站密度、天线几何形状、波束成形配置以及不同技术的集成和协调水平。

* 在考虑毫米波网络时，除了信道的快速变化之外，由于通信的方向性，基于 CRS 的估计具有挑战性，因此需要网络和 UE 不断监测每个潜在链路的传输方向. 跟踪不断变化的方向会降低网络适应的速度，并且可能是在面临可变链路质量时提供强大且无处不在的服务的主要障碍。此外，UE和gNB可能一次只能监听一个方向，从而难以接收切换路径所需的控制信令。

* *NSA*或独立 (SA)架构。非独立是一种部署配置，其中 NR gNB 使用 LTE 小区作为控制平面管理的支持并且移动终端利用多连接来维护到不同小区的多个可能的连接（例如，4G 和 5G 覆盖），因此可以通过切换数据路径来克服一个链路中的丢失. NSA 部署中的移动设备可以从毫米波链路提供的高比特率和更强大但速率更低的传统信道中受益，从而开辟解决容量问题的新方法以及新方法提供良好的移动网络性能和稳健性。相反，对于独立选项，没有 LTE 控制平面，因此不支持 LTE 和 NR 之间的集成。

* 自定义度量值：

    * 漏检概率$P_{MP}$定义为 UE 未被基站检测到的概率（即信噪比低于阈值 )。

    * 灵敏度：对于非连接用户，即对于 IA，它由找到最佳波束对的平均时间表示。对于连接的用户，即跟踪，它是在 SS 突发后接收第一个 CSI-RS 所需的时间，从而对信道变化或移动性做出反应以最终切换波束，或宣布无线电链路故障 (RLF) 。

    * 开销：相对于可用资源总量分配给框架的时间和频率资源量，同时考虑 IA（即，SS 块或 SRS 和 RACH）和跟踪（即，CSI-RS）。

![giord.t4-2869411-small](%E6%B3%A2%E6%9D%9F%E7%AE%A1%E7%90%86.assets/giord.t4-2869411-small.gif)

<center>性能指标和参数之间的关系</center>

* 波束成形：

    * 模拟波束成形通过所有天线元件的单个射频 (RF) 链对波束进行整形，因此处理是在模拟域中执行的，但是在任何给定时间仅在一个方向上发送/接收。该模型通过仅使用一对模数转换器 (ADC) 来节省功率，但由于收发器只能在一个方向上形成波束，因此灵活性很小。

    * 合波束成形用$K_{RF}$个射频链 ($K_{RF} \lt N_t$)，因此等价于 $K_{RF}$个并行模拟波束并使收发器能够发送/接收 在$K_{RF}$方向同时进行。然而当混合波束成形用于传输时，每个传输波束的可用功率是总节点功率约束除以$K_{RF}$ ，因此可能会降低接收功率。

    * 字波束成形每个天线元件都需要单独的 RF 链和数据转换器，因此允许在数字域中处理接收到的信号，从而可能使收发器能够在$N_t$方向上引导波束。使用数字波束成形同时传输多个波束会导致每个波束可用的传输功率降低（即总功率约束适用于所有波束的总和，而不是单独应用于每个波束）。而且数字收发器最多可以同时处理$N_t$个正交波束，没有任何波束间干扰（即通过迫零波束成形结构）。
* 当网络密集化和使用更大的阵列时，可以实现更好的检测精度性能。网络密集化，从而确保更好的信号质量和更强的接收功率。使用更大的阵列，可以控制更窄的波束，从而保证波束成形产生的更高增益。
* UE 全向发送或接收的波束赋形策略，虽然保证了快速接入操作，但并不能确保准确的 IA 性能并导致检测能力下降。更具体地说，与完全定向架构的差距在非常密集的场景下非常显着，并且随着 gNB 密度的增加而增加。
* 增加子载波间隔和SS块信息在多个频率子带中的重复次数可以降低误检测能力。
* gNB和UE需要分别扫描$N_{\theta,gNB} N_{\phi,gNB} ,N_{\theta,UE} N_{\phi,UE} $方向来覆盖整个水平和垂直空间，其中$N_\theta, N_\phi $为水平和垂直划分的区间个数。
* 可以通过在 UE 处使用全向天线，通过减少 UE/gNB 处的天线、使用混合/数字波束成形实现同时收发多流数据数量来减少扫描时间。
* 当使用较大的间隔时，OFDM符号的持续时间较短，并且可以较早完成感兴趣方向上的SS块的传输。
* 波束报告延迟：
  * 非独立组网下，则波束决策将通过 LTE 接口转发（并且只需要一个 RACH 机会），这使得波束报告具有反应性等于传统 LTE 连接的延迟（10,4,0.8ms）。
  * 独立组网在波束报告时，移动终端必须等待 gNB 将 RACH 机会调度到 UE 刚刚确定的最佳方向，以执行随机接入并隐式通知所选服务基础设施最佳方向，以便正确对齐。报告耗时与UE侧的天线配置无关，因为移动终端通过先前确定的最佳方向引导其波束并且不需要执行波束扫描操作。SA 方案对大多数研究的配置都表现出非常好的反应性，其性能也优于 NSA 解决方案。原因是，如果网络能够在单个 SS 突发内分配所需的 RACH 资源，则可以限制波束报告操作对整体初始接入反应性的影响，整个IA耗时由波束扫描阶段主导，特别是在考虑小天线因素和采用数字波束成形时。
  * 
* 当使用较小的子载波间隔（即 ΔF= 120 kHz）有可能实现更高的准确度（即更小的误检概率），这是因为噪声的影响不太相关。
* 每个SS Burst中的 SS 块数量越多，在单个突发中完成扫描的可能性就越大，从而防止IA耗时依赖SS Burst周期，然而每个突发的 SS 块数量也会线性增加开销。SS Burst周期 与要扫描的方向数量有严格的关系，即波束成形架构（混合、数字波束成形可以实现同时传输多流数据）和天线数量。
* 如果扫描可以在一次突发中完成，则更高SS Burst周期将减少开销并增加 CSI-RS 的反应性。
* 接收器侧的数字波束成形架构将提高测量方案的反应性并减少开销，而不会影响精度。全向接收器可以在反应性和开销方面实现相同的改进，但精度会下降。然而收发器实现的复杂性和能耗是两个必须考虑的重要参数。混合配置可以代表改进的反应性和更简单且消耗更少的收发器设计之间的权衡。如果在基于上行链路的框架中在 gNB 处使用数字架构，则数字架构允许更高的无功增益，因为要在 gNB 处扫描的方向通常比在 UE 处扫描的方向多。
* 由于 UE（下行链路）或 gNB（上行链路）的接收功率增加，更多数量的天线单元可实现更窄的波束和更高的精度。然而，波束的宽度与扫描方向的数量成反比，因此提供更高精度的配置在反应性和开销方面表现更差。
* 就初始访问而言，独立方案的实现通常可以保证更多的反应性访问能力。原因是如果可以在单个 SS 突发内分配多个 SS 块和 RACH 机会，则可以确保更快的波束报告操作。另一方面，非独立框架可能更适合： (i) 减少波束报告阶段的开销影响；(ii) 在连接模式下，一旦检测到无线电链路故障事件，就实施高效的反应式恢复操作；(iii) 保证更稳健的控制信令交换（例如，在转发波束报告消息时）。
* 由于网络密度低，更大的天线阵列可以检测到更远的用户，并提供更广泛的覆盖范围，但是，由于λ乙 增加，可以对 SS 突发使用宽波束配置（以便更有可能在单个突发中完成扫描）和窄波束用于 CSI-RS，以细化数据传输的指向方向并实现更高的收益。